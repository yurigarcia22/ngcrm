<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectSphere Prospect CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" defer></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" defer></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .kanban-column.drag-over { background-color: #e0f2fe; border-color: #38bdf8; }
        .prospect-card.dragging { opacity: 0.5; transform: rotate(3deg); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, Fragment } = React;

        // --- 1. CONFIGURAÇÃO E CONSTANTES ---
        const supabaseUrl = 'https://ekzjsqheinpvebjfjims.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrempzcWhlaW5wdmViamZqaW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5OTIzNDMsImV4cCI6MjA2NjU2ODM0M30.HrBFnV6ve6po2GeitFXs55ensNljsXs-1aSVwdKHDDA';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        const KANBAN_STAGES = ['Novo', 'Contato Inicial', 'Qualificação', 'Proposta', 'Fechado', 'Perdido'];

        // --- 2. COMPONENTES DE UI ---
        // (Componentes ProspectCard, ProspectModal, KanbanView, etc. - mantidos do seu design original)
        // As lógicas internas deles agora vão se conectar aos handlers do App principal.

        // --- 3. APP PRINCIPAL ---
        function App() {
            // Estados de Autenticação e UI
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedProspect, setSelectedProspect] = useState(null);

            // Estados de Dados (agora vazios, carregados do Supabase)
            const [prospects, setProspects] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [users, setUsers] = useState([]); // Usaremos a tabela 'profiles' para isso

            // --- LÓGICA DE AUTENTICAÇÃO E CARREGAMENTO DE DADOS ---
            useEffect(() => {
                const session = supabase.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user ?? null);
                    if (!session?.user) setIsLoading(false);
                });
                const { data: authListener } = supabase.auth.onAuthStateChange((_event, session) => {
                    setUser(session?.user ?? null);
                    if (!session?.user) setIsLoading(false);
                });
                return () => authListener.subscription.unsubscribe();
            }, []);

            useEffect(() => {
                if (user) {
                    fetchInitialData();
                }
            }, [user]);

            const fetchInitialData = async () => {
                setIsLoading(true);
                await Promise.all([
                    fetchProspects(),
                    fetchTasks(),
                    fetchProfiles() // Carrega os perfis dos usuários
                ]);
                setIsLoading(false);
            };

            const fetchProspects = async () => {
                const { data, error } = await supabase.from('prospects').select('*');
                if (error) console.error("Erro ao buscar prospects:", error);
                else setProspects(data || []);
            };
            const fetchTasks = async () => {
                const { data, error } = await supabase.from('tasks').select('*');
                if (error) console.error("Erro ao buscar tarefas:", error);
                else setTasks(data || []);
            };
            const fetchProfiles = async () => {
                const { data, error } = await supabase.from('profiles').select('*');
                if (error) console.error("Erro ao buscar perfis:", error);
                else {
                    setUsers(data || []);
                    // Define o perfil do usuário logado
                    const currentUserProfile = data.find(p => p.id === user.id);
                    setProfile(currentUserProfile);
                }
            };
            
            // --- FUNÇÕES DE MANIPULAÇÃO DE DADOS (HANDLERS) ---
            const handleStatusChange = async (prospectId, newStatus) => {
                setProspects(prev => prev.map(p => p.id === prospectId ? { ...p, status: newStatus } : p));
                const { error } = await supabase.from('prospects').update({ status: newStatus }).eq('id', prospectId);
                if (error) {
                    alert("Erro ao atualizar o prospect.");
                    fetchProspects(); // Reverte em caso de erro
                }
            };

            const handleSaveProspect = async (prospectData) => {
                const dataToSave = { ...prospectData, userId: user.id };
                let error;
                if (dataToSave.id) { // Editando
                    const { id, ...updateData } = dataToSave;
                    ({ error } = await supabase.from('prospects').update(updateData).eq('id', id));
                } else { // Criando
                    delete dataToSave.id;
                    ({ error } = await supabase.from('prospects').insert(dataToSave));
                }
                if (error) {
                    alert("Erro ao salvar prospect: " + error.message);
                } else {
                    handleCloseModal();
                    await fetchProspects();
                }
            };

            const handleAddTask = async (prospect, description, dueDate) => {
                const newTask = { prospectId: prospect.id, userId: user.id, description, dueDate, type: 'Follow-up' };
                const { error } = await supabase.from('tasks').insert(newTask);
                if (error) {
                    alert("Erro ao agendar tarefa: " + error.message);
                } else {
                    alert(`Tarefa '${description}' agendada para ${prospect.name}.`);
                    await fetchTasks();
                }
            };
            
            // E assim por diante para todas as outras funções... (handleTaskToggle, etc.)

            const handleCardClick = (prospect) => { setSelectedProspect(prospect); setIsModalOpen(true); };
            const handleCloseModal = () => { setIsModalOpen(false); setSelectedProspect(null); };

            // --- RENDERIZAÇÃO ---
            if (isLoading) return <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh', backgroundColor: '#1e3a8a', color: 'white', fontSize: '2rem'}}>Carregando...</div>;

            if (!user) {
                // Seu formulário de login aqui
                // ...
                return <div>Tela de Login</div>;
            }

            const renderView = () => {
                const props = { prospects, users, tasks, onStatusChange: handleStatusChange, onCardClick: handleCardClick };
                switch (view) {
                    case 'kanban': return <KanbanView {...props} />;
                    case 'list': return <ListView {...props} />;
                    case 'tasks': return <TasksView {...props} />;
                    case 'dashboard': default: return <DashboardView {...props} />;
                }
            };
            
            // Recriando os componentes de UI aqui para manter a estrutura do seu arquivo original
            // Placeholder para os componentes. Você pode colar os seus aqui.
            const KanbanView = (props) => <div>Kanban View: {props.prospects.length} prospects</div>;
            const ListView = (props) => <div>List View</div>;
            const TasksView = (props) => <div>Tasks View</div>;
            const DashboardView = (props) => <div>Dashboard View</div>;
            // ...e assim por diante para todos os outros componentes...

            return (
                <Fragment>
                    {/* <ProspectModal ... /> */}
                    <div className="h-screen w-screen flex flex-col bg-slate-50">
                        <header className="bg-white shadow-sm p-4 flex justify-between items-center border-b z-10">
                            <h1 className="text-xl font-bold text-gray-800">ConnectSphere Prospect</h1>
                            <nav className="flex items-center space-x-2">
                                <button onClick={() => setView('dashboard')}>Dashboard</button>
                                <button onClick={() => setView('kanban')}>Kanban</button>
                                <button onClick={() => setView('list')}>Lista</button>
                                <button onClick={() => setView('tasks')}>Tarefas</button>
                            </nav>
                            <div className="flex items-center space-x-4">
                               <button onClick={() => setIsModalOpen(true)}>Adicionar Prospect</button>
                               <span>Olá, {profile?.name || user.email}</span>
                               <button onClick={() => supabase.auth.signOut()}>Sair</button>
                            </div>
                        </header>
                        <main className="flex-1 overflow-y-auto">{renderView()}</main>
                    </div>
                </Fragment>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
