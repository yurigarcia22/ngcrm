<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NG PROSPECT</title>
    
    <!-- Scripts com DEFER para garantir a ordem de carregamento correta -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" defer></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" defer></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F5F5F5; overflow: hidden; }
        .dark, .dark body { background-color: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .kanban-column.drag-over { background-color: rgba(247, 94, 103, 0.1) !important; }
        .prospect-card.dragging { opacity: 0.5; transform: rotate(3deg) scale(1.05); }
        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .confetti { position: absolute; width: 10px; height: 10px; opacity: 0.7; animation: fall 4s linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
        .login-container, .loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #202C6D; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, Fragment, createContext, useContext } = React;

        // --- 1. CONFIGURAÇÃO E CONSTANTES ---
        const supabaseUrl = 'https://ekzjsqheinpvebjfjims.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrempzcWhlaW5wdmViamZqaW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5OTIzNDMsImV4cCI6MjA2NjU2ODM0M30.HrBFnV6ve6po2GeitFXs55ensNljsXs-1aSVwdKHDDA';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        const KANBAN_STAGES = ['Novo', 'Contato Inicial', 'Contato com Decisor', 'Proposta Enviada', 'Venda', 'Perdido', 'No Show'];
        const CRM_FIELDS = ['name', 'contactName', 'email', 'phone', 'value', 'status'];
        const CRM_FIELD_LABELS = { name: 'Nome da Empresa', contactName: 'Nome do Contato', email: 'E-mail', phone: 'Telefone', value: 'Valor da Proposta', status: 'Status' };
        
        // --- 2. CONTEXTO DE TEMA (DARK MODE) ---
        const ThemeContext = createContext();
        const useTheme = () => useContext(ThemeContext);
        function ThemeProvider({ children }) {
            const [theme, setTheme] = useState('dark');
            useEffect(() => { const storedTheme = localStorage.getItem('crm-theme') || 'dark'; setTheme(storedTheme); }, []);
            useEffect(() => { document.documentElement.classList.remove('light', 'dark'); document.documentElement.classList.add(theme); }, [theme]);
            const toggleTheme = () => {
                setTheme(prev => {
                    const newTheme = prev === 'light' ? 'dark' : 'light';
                    localStorage.setItem('crm-theme', newTheme);
                    return newTheme;
                });
            };
            return (<ThemeContext.Provider value={{ theme, toggleTheme }}>{children}</ThemeContext.Provider>);
        }

        // --- 3. ÍCONES SVG ---
        const Icons = {
            dashboard: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>,
            kanban: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>,
            list: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            tasks: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            sun: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            moon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
            contact: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 18a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2"/><rect x="3" y="4" width="18" height="18" rx="2"/><circle cx="12" cy="10" r="2"/></svg>,
            phone: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            money: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            interactions: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>,
            upload: <svg xmlns="http://www.w3.org/2000/svg" className="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h1.586A2 2 0 0114.172 4.414l.707.707A2 2 0 0016.586 6H17a4 4 0 014 4v5a4 4 0 01-4 4H7z M12 12a3 3 0 100-6 3 3 0 000 6z" /></svg>,
            check: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>,
            cross: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>,
            edit: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg>,
            taskLog: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>,
            search: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" /></svg>,
            arrow: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" /></svg>,
            calendar: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
        };

        // --- 4. COMPONENTES DE UI COMPLETOS (BASEADOS NO SEU DESIGN) ---

        function Confetti() {
            const confettiCount = 150;
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];
            const particles = useMemo(() => Array.from({ length: confettiCount }).map((_, i) => ({ id: i, color: colors[Math.floor(Math.random() * colors.length)], left: `${Math.random() * 100}%`, animationDelay: `${Math.random() * 4}s`, duration: `${2 + Math.random() * 2}s`, transform: `rotate(${Math.random() * 360}deg)` })), []);
            return (<div className="confetti-container">{particles.map(p => (<div key={p.id} className="confetti" style={{ backgroundColor: p.color, left: p.left, animationDuration: p.duration, animationDelay: p.animationDelay, transform: p.transform }}/>))}</div>);
        }

        function ProspectCard({ prospect, onDragStart, onCardClick, contactCount }) {
            return (
                <div draggable="true" onDragStart={(e) => { onDragStart(e, prospect.id); e.currentTarget.classList.add('dragging'); }} onDragEnd={(e) => e.currentTarget.classList.remove('dragging')} onClick={() => onCardClick(prospect)}
                    className="bg-brand-base-white dark:bg-slate-900 rounded-lg shadow-md p-4 mb-4 border-l-4 border-brand-coral hover:shadow-xl transition-all duration-200 cursor-pointer prospect-card" >
                    <h3 className="font-semibold text-brand-text-dark dark:text-brand-text-light truncate">{prospect.name}</h3>
                    <div className="text-sm text-gray-500 dark:text-gray-400 mt-2 space-y-1.5">
                        <p className="flex items-center text-brand-coral"><span className="mr-2">{Icons.contact}</span>{prospect.contactName}</p>
                        <p className="flex items-center font-medium text-gray-600 dark:text-gray-300"><span className="mr-2 text-brand-coral">{Icons.phone}</span>{prospect.phone}</p>
                        <p className="flex items-center"><span className="mr-2 text-brand-coral">{Icons.money}</span>{(prospect.value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        <p className="flex items-center font-semibold"><span className="mr-2 text-brand-coral">{Icons.interactions}</span>{contactCount} contatos</p>
                    </div>
                </div>
            );
        }

        function ProspectModal({ isOpen, onClose, prospect, users, tasks, onSave, onRegisterCadence, onAddTask }) {
            if (!isOpen || !prospect) return null;
            const [editedData, setEditedData] = useState(prospect);
            const [selectedActions, setSelectedActions] = useState([]);
            const [newTaskDesc, setNewTaskDesc] = useState('');
            const [newTaskDate, setNewTaskDate] = useState('');
            useEffect(() => { setEditedData(prospect); setSelectedActions([]); setNewTaskDesc(''); setNewTaskDate(''); }, [prospect]);
            const handleChange = (e) => { const { name, value } = e.target; setEditedData(prev => ({...prev, [name]: name === 'value' ? parseFloat(value) || 0 : value })); };
            const handleSave = () => { if (onSave(editedData)) { onClose(); } };
            const handleActionToggle = (actionType) => { setSelectedActions(prev => prev.includes(actionType) ? prev.filter(a => a !== actionType) : [...prev, actionType]); };
            const handleRegisterClick = () => { if(selectedActions.length === 0) { alert('Selecione pelo menos uma ação para registrar.'); return; } onRegisterCadence(prospect, selectedActions); setSelectedActions([]); };
            const timeline = useMemo(() => { const pTasks = (tasks || []).filter(t => t.prospectId === prospect.id).map(t => ({...t, type: 'task'})); const pHistory = (prospect.editHistory || []).map(h => ({...h, type: 'edit'})); return [...pTasks, ...pHistory].sort((a,b) => new Date(b.dueDate || b.timestamp) - new Date(a.dueDate || a.timestamp)); }, [tasks, prospect]);
            const handleScheduleTask = () => { if(!newTaskDesc || !newTaskDate) { alert("Por favor, preencha a descrição e a data da tarefa."); return; } onAddTask(prospect, newTaskDesc, newTaskDate); setNewTaskDesc(''); setNewTaskDate(''); };
            const QuickActionButton = ({ type, color, children }) => { const isSelected = selectedActions.includes(type); return (<button onClick={() => handleActionToggle(type)} className={`px-3 py-1.5 text-sm font-semibold rounded-lg transition-all duration-200 border-2 ${isSelected ? `${color.selectedBg} ${color.selectedText} ${color.selectedBorder}` : `${color.bg} text-white hover:${color.hoverBg}`}`}>{children}</button>) };
            const actionColors = { 'Ligação': { bg: 'bg-violet-500', hoverBg: 'bg-violet-600', selectedBg: 'bg-violet-100', selectedText: 'text-violet-700', selectedBorder: 'border-violet-500' }, 'Conexão': { bg: 'bg-green-500', hoverBg: 'bg-green-600', selectedBg: 'bg-green-100', selectedText: 'text-green-700', selectedBorder: 'border-green-500' }, 'Decisor': { bg: 'bg-orange-500', hoverBg: 'bg-orange-600', selectedBg: 'bg-orange-100', selectedText: 'text-orange-700', selectedBorder: 'border-orange-500' }, 'Reunião Marcada': { bg: 'bg-indigo-500', hoverBg: 'bg-indigo-600', selectedBg: 'bg-indigo-100', selectedText: 'text-indigo-700', selectedBorder: 'border-indigo-500' }, 'Reunião Realizada': { bg: 'bg-teal-500', hoverBg: 'bg-teal-600', selectedBg: 'bg-teal-100', selectedText: 'text-teal-700', selectedBorder: 'border-teal-500' }, 'Venda': { bg: 'bg-amber-400', hoverBg: 'bg-amber-500', selectedBg: 'bg-amber-100', selectedText: 'text-amber-700', selectedBorder: 'border-amber-500' }, };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                    <div className="bg-brand-base-white dark:bg-slate-800 rounded-lg shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
                        <div className="p-4 border-b dark:border-slate-700 flex justify-between items-center"><h2 className="text-xl font-semibold text-brand-text-dark dark:text-brand-text-light">{editedData.name || "Novo Prospect"}</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div>
                        <div className="flex-1 flex overflow-hidden">
                            <div className="w-1/2 p-6 border-r dark:border-slate-700 overflow-y-auto custom-scrollbar"><div className="space-y-4"><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300">nome da empresa</label><input type="text" name="name" value={editedData.name} onChange={handleChange} className="mt-1 block w-full bg-brand-base-gray dark:bg-slate-700 border-transparent rounded-md shadow-sm p-2 focus:ring-brand-coral focus:border-brand-coral" /></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300">nome do contato</label><input type="text" name="contactName" value={editedData.contactName} onChange={handleChange} className="mt-1 block w-full bg-brand-base-gray dark:bg-slate-700 border-transparent rounded-md shadow-sm p-2 focus:ring-brand-coral focus:border-brand-coral" /></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300">e-mail</label><input type="email" name="email" value={editedData.email || ''} onChange={handleChange} className="mt-1 block w-full bg-brand-base-gray dark:bg-slate-700 border-transparent rounded-md shadow-sm p-2 focus:ring-brand-coral focus:border-brand-coral" /></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300">telefone</label><input type="tel" name="phone" value={editedData.phone || ''} onChange={handleChange} className="mt-1 block w-full bg-brand-base-gray dark:bg-slate-700 border-transparent rounded-md shadow-sm p-2 focus:ring-brand-coral focus:border-brand-coral" /></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300">valor</label><input type="number" name="value" value={editedData.value} onChange={handleChange} className="mt-1 block w-full bg-brand-base-gray dark:bg-slate-700 border-transparent rounded-md shadow-sm p-2 focus:ring-brand-coral focus:border-brand-coral" /></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300">status</label><select name="status" value={editedData.status} onChange={handleChange} className="mt-1 block w-full bg-brand-base-gray dark:bg-slate-700 border-transparent rounded-md shadow-sm p-2 focus:ring-brand-coral focus:border-brand-coral">{KANBAN_STAGES.map(s => <option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300">responsável</label><select name="userId" value={editedData.userId} onChange={handleChange} className="mt-1 block w-full bg-brand-base-gray dark:bg-slate-700 border-transparent rounded-md shadow-sm p-2 focus:ring-brand-coral focus:border-brand-coral">{users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}</select></div><button onClick={handleSave} className="w-full mt-2 px-4 py-2 bg-brand-coral text-white rounded-lg font-semibold hover:bg-brand-coral-dark shadow-sm hover:shadow-lg transition-all lowercase">salvar</button></div>
                               <div className="mt-6 pt-6 border-t dark:border-slate-700"><h3 className="text-lg font-semibold text-brand-text-dark dark:text-brand-text-light flex items-center gap-2 mb-4">{Icons.calendar} Tarefas de Follow-up</h3><div className="space-y-3"><input type="text" placeholder="descreva a próxima ação..." value={newTaskDesc} onChange={(e) => setNewTaskDesc(e.target.value)} className="block w-full bg-brand-base-gray dark:bg-slate-700 border-transparent rounded-md shadow-sm p-2 focus:ring-brand-coral focus:border-brand-coral lowercase" /><input type="date" value={newTaskDate} onChange={(e) => setNewTaskDate(e.target.value)} className="block w-full bg-brand-base-gray dark:bg-slate-700 border-transparent rounded-md shadow-sm p-2 focus:ring-brand-coral focus:border-brand-coral" /><button onClick={handleScheduleTask} disabled={!newTaskDesc || !newTaskDate} className="w-full px-4 py-2 bg-brand-coral/80 text-white rounded-lg font-semibold hover:bg-brand-coral disabled:bg-gray-400 lowercase">agendar</button></div></div>
                            </div>
                            <div className="w-1/2 p-6 overflow-y-auto custom-scrollbar"><h3 className="text-lg font-semibold text-brand-text-dark dark:text-brand-text-light mb-4">histórico de atividades</h3><ul className="space-y-4">{timeline.map((item, index) => (<li key={index} className="flex items-start space-x-3"><div className="mt-1 text-brand-coral">{item.type === 'edit' ? Icons.edit : Icons.taskLog}</div><div><p className="text-sm font-medium text-brand-text-dark dark:text-brand-text-light">{item.type === 'edit' ? `Campo '${item.field}' alterado` : item.description}</p><p className="text-xs text-gray-500 dark:text-gray-400">{item.type === 'edit' ? `de '${item.oldValue}' para '${item.newValue}'` : `Tarefa ${item.completed ? 'concluída' : 'pendente'}`}</p><p className="text-xs text-gray-400 dark:text-gray-500 mt-0.5">{new Date(item.dueDate || item.timestamp).toLocaleString('pt-BR')}</p></div></li>))}</ul></div>
                        </div>
                        <div className="p-4 bg-brand-base-gray/50 dark:bg-slate-900/50 border-t dark:border-slate-700"><h3 className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2 lowercase">ações rápidas (cadência inteligente)</h3><div className="flex flex-wrap gap-2 items-center"><QuickActionButton type="Ligação" color={actionColors['Ligação']}>Ligação</QuickActionButton><QuickActionButton type="Conexão" color={actionColors['Conexão']}>Conexão</QuickActionButton><QuickActionButton type="Decisor" color={actionColors['Decisor']}>Decisor</QuickActionButton><QuickActionButton type="Reunião Marcada" color={actionColors['Reunião Marcada']}>Reunião Marcada</QuickActionButton><QuickActionButton type="Reunião Realizada" color={actionColors['Reunião Realizada']}>Reunião Realizada</QuickActionButton><QuickActionButton type="Venda" color={actionColors['Venda']}>Venda</QuickActionButton><div className="flex-grow flex items-center justify-end gap-4"><span className="text-sm text-gray-600 dark:text-gray-400 font-medium">{selectedActions.length} ação(ões) = 1 cadência</span><button onClick={handleRegisterClick} className="px-4 py-2 bg-brand-coral text-white rounded-lg font-semibold hover:bg-brand-coral-dark disabled:bg-gray-400 lowercase" disabled={selectedActions.length === 0}>registar ações</button></div></div></div>
                    </div>
                </div>
            );
        }
        
        function ImportModal({ isOpen, onClose, onImportSuccess }) {
            const [step, setStep] = useState(1); const [fileHeaders, setFileHeaders] = useState([]); const [fileData, setFileData] = useState([]); const [mapping, setMapping] = useState({}); const [importReport, setImportReport] = useState(null);
            const resetState = () => { setStep(1); setFileHeaders([]); setFileData([]); setMapping({}); setImportReport(null); };
            const handleFileDrop = (e) => { e.preventDefault(); const file = e.dataTransfer.files[0]; processFile(file); };
            const handleFileSelect = (e) => { const file = e.target.files[0]; processFile(file); };
            const processFile = (file) => { if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); const headers = json[0] || []; const records = json.slice(1).map(row => { let record = {}; headers.forEach((header, i) => record[header] = row[i]); return record; }); setFileHeaders(headers); setFileData(records); autoMapColumns(headers); setStep(2); }; reader.readAsArrayBuffer(file); };
            const autoMapColumns = (headers) => { const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9]/gi, ''); let newMapping = {}; headers.forEach(header => { const normalizedHeader = normalize(header); const match = CRM_FIELDS.find(field => normalize(CRM_FIELD_LABELS[field]).includes(normalizedHeader)); newMapping[header] = match || ''; }); setMapping(newMapping); };
            const handleMappingChange = (header, crmField) => { setMapping(prev => ({...prev, [header]: crmField })); };
            const handleConfirmImport = () => { onImportSuccess(fileData, mapping); setImportReport({ success: fileData.length, failed: 0, duplicates: 0 }); setStep(3); };
            const handleClose = () => { resetState(); onClose(); };
            return ( isOpen && (<div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"><div className="bg-brand-base-white dark:bg-slate-800 rounded-lg shadow-2xl w-full max-w-3xl"><div className="p-4 border-b dark:border-slate-700 flex justify-between items-center"><h2 className="text-xl font-semibold text-brand-text-dark dark:text-brand-text-light">importar contatos - passo {step}/3</h2><button onClick={handleClose} className="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div>
                {step === 1 && (<div onDrop={handleFileDrop} onDragOver={(e) => e.preventDefault()} className="p-8 border-dashed border-2 border-gray-300 dark:border-slate-600 m-8 rounded-lg text-center">{Icons.upload}<p className="mt-2 text-sm text-gray-600 dark:text-gray-300">Arraste e solte o seu ficheiro .csv ou .xlsx aqui</p><p className="text-xs text-gray-500 mt-1">ou</p><label htmlFor="file-upload" className="cursor-pointer mt-2 inline-block bg-brand-coral text-white font-semibold py-2 px-4 rounded-lg hover:bg-brand-coral-dark lowercase">selecione um ficheiro</label><input id="file-upload" name="file-upload" type="file" className="sr-only" onChange={handleFileSelect} accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" /><div className="mt-6 p-4 bg-brand-base-gray/50 dark:bg-slate-700/50 rounded-lg text-left"><p className="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2">sequência recomendada de colunas:</p><div className="grid grid-cols-3 sm:grid-cols-5 gap-2 text-center text-xs"><span className="bg-slate-200 dark:bg-slate-600 p-2 rounded truncate font-medium">Nome da Empresa</span><span className="bg-slate-200 dark:bg-slate-600 p-2 rounded truncate font-medium">Nome do Contato</span><span className="bg-slate-200 dark:bg-slate-600 p-2 rounded truncate font-medium">E-mail</span><span className="bg-slate-200 dark:bg-slate-600 p-2 rounded truncate font-medium">Telefone</span><span className="bg-slate-200 dark:bg-slate-600 p-2 rounded truncate font-medium">Valor</span></div></div></div>)}
                {step === 2 && (<div className="p-8"><h3 className="font-semibold text-brand-text-dark dark:text-brand-text-light mb-4">mapeie as colunas do seu ficheiro:</h3><div className="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-4">{fileHeaders.map(header => (<div key={header} className="grid grid-cols-2 gap-4 items-center"><span className="font-medium text-gray-600 bg-gray-100 dark:bg-slate-700 p-2 rounded-md truncate">{header}</span><select value={mapping[header] || ''} onChange={(e) => handleMappingChange(header, e.target.value)} className="block w-full border-transparent bg-brand-base-gray dark:bg-slate-700 rounded-md shadow-sm p-2 focus:ring-brand-coral focus:border-brand-coral"><option value="">ignorar esta coluna</option>{CRM_FIELDS.map(field => <option key={field} value={field}>{CRM_FIELD_LABELS[field]}</option>)}</select></div>))}</div><div className="mt-8 flex justify-end"><button onClick={handleConfirmImport} disabled={!Object.values(mapping).some(v => v === 'name' || v === 'contactName')} className="px-6 py-2 bg-brand-coral text-white rounded-lg font-semibold hover:bg-brand-coral-dark disabled:bg-gray-400 lowercase">importar</button></div></div>)}
                {step === 3 && (<div className="p-8 text-center"><h3 className="text-2xl font-bold text-green-600 mb-4">importação concluída!</h3><div className="space-y-2 text-lg text-brand-text-dark dark:text-brand-text-light"><p className="flex items-center justify-center text-green-600">{Icons.check} {importReport.success} contatos importados com sucesso.</p><p className="flex items-center justify-center text-red-500">{Icons.cross} {importReport.failed} contatos falharam.</p></div><button onClick={handleClose} className="mt-8 px-6 py-2 bg-brand-coral text-white rounded-lg font-semibold hover:bg-brand-coral-dark lowercase">fechar</button></div>)}
            </div></div>) );
        }

        function KanbanView({ prospects, users, tasks, onStatusChange, onCardClick, handleDragStart }) {
            const handleDragOver = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over') };
            const handleDragLeave = (e) => e.currentTarget.classList.remove('drag-over');
            const handleDrop = (e, newStatus) => { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); const prospectId = e.dataTransfer.getData("prospectId"); onStatusChange(parseInt(prospectId), newStatus); };
            const prospectsByStage = useMemo(() => { const grouped = {}; KANBAN_STAGES.forEach(stage => grouped[stage] = []); (prospects || []).forEach(p => { if (grouped[p.status]) grouped[p.status].push(p) }); return grouped; }, [prospects]);
            return (<div className="flex-1 p-4 sm:p-6 lg:p-8 overflow-x-auto custom-scrollbar"><div className="flex gap-6 min-w-max h-full">{KANBAN_STAGES.map(stage => (<div key={stage} className="bg-brand-base-white/60 dark:bg-slate-800/60 rounded-xl w-80 flex-shrink-0 flex flex-col kanban-column border-2 border-transparent transition-colors" onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={(e) => handleDrop(e, stage)}><div className={`p-4 border-b-2 dark:border-slate-700 ${stage === 'Venda' ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' : ''} ${stage === 'Perdido' || stage === 'No Show' ? 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300' : 'dark:border-slate-700'}`}><h2 className="font-semibold text-brand-text-dark dark:text-brand-text-light">{stage} <span className="text-sm font-medium text-gray-500 dark:text-gray-400">{(prospectsByStage[stage] || []).length}</span></h2></div><div className="p-2 h-full overflow-y-auto custom-scrollbar">{(prospectsByStage[stage] || []).map(prospect => { const contactCount = (tasks || []).filter(t => t.prospectId === prospect.id && t.completed && t.type === 'Cadência').length; return <ProspectCard key={prospect.id} prospect={prospect} onCardClick={onCardClick} contactCount={contactCount} onDragStart={handleDragStart} />; })}</div></div>))}</div></div>);
        }
        
        function ListView({ prospects, users, tasks, onCardClick, onSelect, selectedIds }) {
            const [filter, setFilter] = useState(''); const [collapsedStages, setCollapsedStages] = useState({});
            const toggleStage = (stage) => { setCollapsedStages(prev => ({ ...prev, [stage]: !prev[stage] })); };
            const stageColors = { 'Novo': 'bg-gray-500', 'Contato Inicial': 'bg-blue-500', 'Contato com Decisor': 'bg-purple-500', 'Proposta Enviada': 'bg-orange-500', 'Venda': 'bg-green-500', 'Perdido': 'bg-red-500', 'No Show': 'bg-red-700' };
            const filteredProspects = useMemo(() => (prospects || []).filter(p => p.name.toLowerCase().includes(filter.toLowerCase())), [prospects, filter]);
            const prospectsByStage = useMemo(() => { const grouped = {}; KANBAN_STAGES.forEach(stage => grouped[stage] = []); filteredProspects.forEach(p => grouped[p.status]?.push(p)); return grouped; }, [filteredProspects]);
            return (<div className="flex-1 p-4 sm:p-6 lg:p-8 flex flex-col"><div className="mb-6"><div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">{Icons.search}</div><input type="text" placeholder="Filtrar por nome do prospect..." value={filter} onChange={(e) => setFilter(e.target.value)} className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-brand-base-white dark:bg-slate-900 placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-brand-coral focus:border-brand-coral sm:text-sm" /></div></div><div className="flex-1 overflow-y-auto custom-scrollbar pr-2"><div className="space-y-4">{KANBAN_STAGES.map(stage => { const prospectsInStage = prospectsByStage[stage]; const isCollapsed = collapsedStages[stage]; if(filter && prospectsInStage.length === 0) return null; return (<div key={stage} className="bg-brand-base-white dark:bg-slate-900 rounded-lg shadow-sm"><div className="p-3 flex items-center justify-between cursor-pointer" onClick={() => toggleStage(stage)}><div className="flex items-center gap-3"><span className={`${isCollapsed ? '' : 'rotate-90'}`}>{Icons.arrow}</span><span className={`px-3 py-1 text-xs font-bold text-white rounded-full ${stageColors[stage]}`}>{stage}</span><span className="text-sm font-semibold text-gray-600 dark:text-gray-300">{prospectsInStage.length}</span></div></div>{!isCollapsed && (<div className="border-t border-gray-200 dark:border-slate-700">{prospectsInStage.length > 0 ? (<table className="min-w-full"><tbody className="divide-y divide-gray-200 dark:divide-slate-700">{prospectsInStage.map(prospect => { const user = (users || []).find(u => u.id === prospect.userId); const contactCount = (tasks || []).filter(t => t.prospectId === prospect.id && t.completed && t.type === 'Cadência').length; return (<tr key={prospect.id} className="hover:bg-gray-50 dark:hover:bg-slate-800"><td className="px-4 py-3"><input type="checkbox" className="h-4 w-4 rounded border-gray-300 text-brand-coral focus:ring-brand-coral" checked={selectedIds.includes(prospect.id)} onChange={() => onSelect(prospect.id)} /></td><td className="px-4 py-3 whitespace-nowrap cursor-pointer" onClick={() => onCardClick(prospect)}><div className="text-sm font-medium text-brand-text-dark dark:text-brand-text-light">{prospect.name}</div><div className="text-sm text-gray-500 dark:text-gray-400">{prospect.contactName}</div></td><td className="px-4 py-3 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">{prospect.phone}</td><td className="px-4 py-3 whitespace-nowrap text-sm font-bold text-green-600">{prospect.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td><td className="px-4 py-3 whitespace-nowrap text-sm text-brand-coral font-semibold">{contactCount} contatos</td><td className="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200"><span className="flex items-center" title={`Responsável: ${user?.name || 'Não encontrado'}`}><span className="text-lg mr-2">{user?.avatar || '👤'}</span>{user?.name || 'Não encontrado'}</span></td></tr>); })}</tbody></table>) : <p className="px-6 py-4 text-sm text-gray-500">Nenhum prospect nesta etapa.</p>}</div>)}</div>); })}</div></div></div>);
        }
        
        function TasksView({ tasks, prospects, users, onTaskToggle, onCardClick }) {
            const openTasks = (tasks || []).filter(t => !t.completed && t.type !== 'Cadência').sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            return(<div className="flex-1 p-4 sm:p-6 lg:p-8"><h1 className="text-3xl font-semibold text-brand-text-dark dark:text-brand-text-light mb-6">minhas tarefas</h1><div className="space-y-4">{openTasks.length === 0 && <p className="text-gray-500 dark:text-gray-400">Nenhuma tarefa pendente. Bom trabalho!</p>}{openTasks.map(task => { const prospect = (prospects || []).find(p => p.id === task.prospectId); const user = (users || []).find(u => u.id === task.userId); const isOverdue = new Date(task.dueDate) < new Date() && !task.completed; return (<div key={task.id} onClick={() => prospect && onCardClick(prospect)} className="bg-brand-base-white dark:bg-slate-900 rounded-lg shadow-md p-4 flex items-center justify-between hover:shadow-lg transition-shadow cursor-pointer"><div className="flex items-center"><input type="checkbox" checked={task.completed} onClick={(e) => e.stopPropagation()} onChange={() => onTaskToggle(task.id)} className="h-5 w-5 rounded border-gray-300 text-brand-coral focus:ring-brand-coral"/><div className="ml-4"><p className="text-sm font-medium text-brand-text-dark dark:text-brand-text-light">{task.description}</p><p className="text-sm text-gray-500 dark:text-gray-400">Para: <span className="font-semibold">{prospect?.name || 'Prospect não encontrado'}</span></p></div></div><div className="flex items-center space-x-4"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isOverdue ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>Vence em: {new Date(task.dueDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</span><span className="flex items-center text-gray-600" title={`Responsável: ${user?.name || 'Não encontrado'}`}><span className="text-lg">{user?.avatar || '👤'}</span></span></div></div>); })}</div></div>);
        }
        
        function DashboardView({ prospects, users, tasks }) {
            const ActivityKpiCard = ({ title, value, icon, iconBgColor }) => ( <div className="bg-brand-base-white dark:bg-slate-900 p-5 rounded-lg shadow-md flex items-center justify-between"><div><h3 className="text-sm font-medium text-gray-500 dark:text-gray-400">{title}</h3><p className="mt-1 text-3xl font-semibold text-brand-text-dark dark:text-brand-text-light">{value}</p></div><div className={`p-3 rounded-full ${iconBgColor}`}>{icon}</div></div> );
            const RankingPodium = ({ leaderboard }) => { const topThree = leaderboard.slice(0, 3); const podiumOrder = [1, 0, 2]; const podiumStyles = {0: { bgColor: 'bg-brand-coral', height: 'h-40', rank: '1º' }, 1: { bgColor: 'bg-brand-dark-blue', height: 'h-32', rank: '2º' }, 2: { bgColor: 'bg-brand-dark-blue/70', height: 'h-24', rank: '3º' },}; while(topThree.length < 3) { topThree.push({ id: `placeholder-${topThree.length}`, name: 'Vazio', avatar: '👤', score: 0 });} return (<div className="bg-brand-base-white dark:bg-slate-900 p-6 rounded-lg shadow-md"><h3 className="text-lg font-semibold text-brand-text-dark dark:text-brand-text-light mb-4">pódio da prospecção</h3><div className="flex items-end justify-center gap-4 text-center h-52">{podiumOrder.map(index => { const user = topThree[index]; const style = podiumStyles[index]; if (!user) return null; return (<div key={user.id} className="flex flex-col items-center w-28"><span className="text-4xl mb-2">{user.avatar}</span><p className="font-bold text-brand-text-dark dark:text-brand-text-light truncate w-full">{user.name}</p><div className={`flex items-center justify-center rounded-t-lg w-full ${style.bgColor} ${style.height}`}><div className="text-white font-black text-4xl" style={{ textShadow: '2px 2px 4px rgba(0,0,0,0.2)' }}>{style.rank}</div></div><div className="bg-brand-text-dark w-full p-2 rounded-b-lg text-white font-semibold text-sm">{user.score} pts</div></div>);})}</div></div>);};
            const closedWonValue = useMemo(() => (prospects || []).filter(p => p.status === 'Venda').reduce((sum, p) => sum + p.value, 0), [prospects]);
            const activityKpiData = useMemo(() => { const cadenceTasks = (tasks || []).filter(t => t.type === 'Cadência'); let ligacoes = 0, conexoes = 0, contatoDecisor = 0, reunioes = 0, reunioesRealizadas = 0; cadenceTasks.forEach(task => { if (task.description.includes('Ligação')) ligacoes++; if (task.description.includes('Conexão')) conexoes++; if (task.description.includes('Decisor')) contatoDecisor++; if (task.description.includes('Reunião Marcada')) reunioes++; if (task.description.includes('Reunião Realizada')) reunioesRealizadas++; }); return { ligacoes, conexoes, contatoDecisor, reunioes, reunioesRealizadas, vendas: (prospects || []).filter(p => p.status === 'Venda').length } }, [tasks, prospects]);
            const funnelData = useMemo(() => { const d = {}; KANBAN_STAGES.forEach(s => d[s] = (prospects || []).filter(p => p.status === s).length); return d; }, [prospects]);
            const activitiesPerUser = useMemo(() => { const d = {}; (users || []).forEach(u => d[u.name] = 0); (tasks || []).filter(t => t.completed).forEach(t => { const u = users.find(user => user.id === t.userId); if (u && d[u.name] !== undefined) d[u.name]++; }); return Object.entries(d).sort(([,a],[,b]) => b-a); }, [tasks, users]);
            const leaderboardData = useMemo(() => (users || []).map(user => { const valueSold = (prospects || []).filter(p => p.userId === user.id && p.status === 'Venda').reduce((s, p) => s + p.value, 0); const salesCount = (prospects || []).filter(p => p.userId === user.id && p.status === 'Venda').length; const tasksCompleted = (tasks || []).filter(t => t.userId === user.id && t.completed).length; const score = Math.floor(valueSold / 1000) + (salesCount * 10) + tasksCompleted; return { ...user, score }; }).sort((a, b) => b.score - a.score), [prospects, tasks, users]);
            return (<div className="flex-1 p-4 sm:p-6 lg:p-8 space-y-8 custom-scrollbar overflow-y-auto"><div className="flex justify-between items-center"><div><h1 className="text-3xl font-semibold text-brand-text-dark dark:text-brand-text-light lowercase">dashboard</h1><p className="text-gray-500 dark:text-gray-400">visão geral das suas métricas de prospecção</p></div><div className="flex items-center space-x-4"><select className="p-2 bg-brand-base-white dark:bg-slate-900 dark:text-white border border-gray-300 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-coral"><option>todos os períodos</option></select><select className="p-2 bg-brand-base-white dark:bg-slate-900 dark:text-white border border-gray-300 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-coral"><option>todos os usuários</option>{(users || []).map(u => <option key={u.id} value={u.id}>{u.name}</option>)}</select></div></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><ActivityKpiCard title="ligações" value={activityKpiData.ligacoes} iconBgColor="bg-blue-100" icon={<svg className="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>} /><ActivityKpiCard title="conexões" value={activityKpiData.conexoes} iconBgColor="bg-green-100" icon={<svg className="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>} /><ActivityKpiCard title="contato decisor" value={activityKpiData.contatoDecisor} iconBgColor="bg-purple-100" icon={<svg className="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>} /><ActivityKpiCard title="reuniões" value={activityKpiData.reunioes} iconBgColor="bg-orange-100" icon={<svg className="h-6 w-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>} /></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><ActivityKpiCard title="reuniões realizadas" value={activityKpiData.reunioesRealizadas} iconBgColor="bg-teal-100" icon={Icons.check} /><ActivityKpiCard title="vendas" value={activityKpiData.vendas} iconBgColor="bg-lime-100" icon={Icons.money} /><ActivityKpiCard title="valor vendido" value={closedWonValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} iconBgColor="bg-emerald-100" icon={Icons.money} /></div><div className="grid grid-cols-1 lg:grid-cols-2 gap-8"><div className="bg-brand-base-white dark:bg-slate-900 p-6 rounded-lg shadow-md"><h3 className="text-lg font-semibold text-brand-text-dark dark:text-brand-text-light mb-4">funil de vendas</h3><div className="space-y-3">{Object.entries(funnelData).map(([stage, count]) => (<div key={stage}><div className="flex justify-between text-sm mb-1"><span className="font-medium text-gray-600 dark:text-gray-300">{stage}</span><span className="font-bold text-brand-text-dark dark:text-brand-text-light">{count}</span></div><div className="w-full bg-brand-base-gray dark:bg-slate-700 rounded-full h-2.5"><div className="bg-gradient-to-r from-brand-coral to-pink-400 h-2.5 rounded-full" style={{ width: `${(prospects || []).length > 0 ? (count / (prospects || []).length) * 100 : 0}%` }}></div></div></div>))}</div></div><div className="bg-brand-base-white dark:bg-slate-900 p-6 rounded-lg shadow-md"><h3 className="text-lg font-semibold text-brand-text-dark dark:text-brand-text-light mb-4">ranking de atividades</h3><div className="space-y-4">{activitiesPerUser.map(([name, count]) => (<div key={name}><div className="flex justify-between text-sm mb-1"><span className="font-medium text-gray-600 dark:text-gray-300">{name}</span><span className="font-bold text-brand-text-dark dark:text-brand-text-light">{count} tarefas</span></div><div className="w-full bg-brand-base-gray dark:bg-slate-700 rounded-full h-4"><div className="bg-gradient-to-r from-brand-coral to-pink-400 h-4 rounded-full text-center text-white text-xs" style={{ width: `${(count / Math.max(activitiesPerUser[0]?.[1] || 1, 1)) * 100}%` }}></div></div></div>))}</div></div></div><RankingPodium leaderboard={leaderboardData} /></div>);
        }

        // --- 5. COMPONENTE APP (O GERENCIADOR) ---
        function App() {
            // Estados
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [prospects, setProspects] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [users, setUsers] = useState([]); // Perfis dos usuários
            const [view, setView] = useState('kanban');
            const [showConfetti, setShowConfetti] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [selectedProspect, setSelectedProspect] = useState(null);
            const [selectedIds, setSelectedIds] = useState([]);

            // Efeitos
            useEffect(() => {
                const checkSession = async () => {
                    const { data: { session } } = await supabase.auth.getSession();
                    setUser(session?.user ?? null);
                    if (!session?.user) setIsLoading(false);
                };
                checkSession();
                const { data: authListener } = supabase.auth.onAuthStateChange((_event, session) => { setUser(session?.user ?? null); if (!session?.user) setIsLoading(false); });
                return () => authListener.subscription.unsubscribe();
            }, []);

            useEffect(() => { if (user) fetchInitialData(); }, [user]);
            
            // Funções de Fetch
            const fetchInitialData = async () => { setIsLoading(true); await Promise.all([fetchProspects(), fetchTasks(), fetchProfiles()]); setIsLoading(false); };
            const fetchProspects = async () => { const { data, error } = await supabase.from('CRM DADOS').select('*'); if (error) console.error("Erro ao buscar prospects:", error.message); else setProspects(data || []); };
            const fetchTasks = async () => { const { data, error } = await supabase.from('tasks').select('*'); if (error) console.error("Erro ao buscar tarefas:", error.message); else setTasks(data || []); };
            const fetchProfiles = async () => { const { data, error } = await supabase.from('profiles').select('*'); if (error) console.error("Erro ao buscar perfis:", error.message); else { setUsers(data || []); const currentUserProfile = (data || []).find(p => p.id === user.id); setProfile(currentUserProfile); } };
            
            // Handlers
            const handleLogin = async (e) => { e.preventDefault(); try { const { error } = await supabase.auth.signInWithPassword({ email, password }); if (error) throw error; } catch (error) { alert(error.message); } };
            const handleLogout = async () => { await supabase.auth.signOut(); };
            const handleCardClick = (prospect) => { setSelectedProspect(prospect); setIsModalOpen(true); };
            const handleNewProspectClick = () => { setSelectedProspect({ name: '', contactName: '', value: 0, status: 'Novo', userId: user.id, email: '', phone: '', editHistory: [] }); setIsModalOpen(true); };
            const handleCloseModal = () => { setIsModalOpen(false); setSelectedProspect(null); };
            const triggerCelebration = () => { setShowConfetti(true); setTimeout(() => setShowConfetti(false), 4000); };

            const handleStatusChange = async (prospectId, newStatus) => { 
                const prospect = prospects.find(p => p.id === prospectId);
                if (newStatus === 'Venda' && prospect.status !== 'Proposta Enviada') {
                    alert('Ação bloqueada: Um prospect só pode ir para "Venda" após ter uma "Proposta Enviada".'); return;
                }
                if (prospect && prospect.status !== 'Venda' && newStatus === 'Venda') triggerCelebration();

                setProspects(prev => prev.map(p => p.id === prospectId ? { ...p, status: newStatus } : p));
                const { error } = await supabase.from('CRM DADOS').update({ status: newStatus }).eq('id', prospectId);
                if (error) { alert("Erro ao atualizar o status."); await fetchProspects(); }
            };

            const handleSaveProspect = async (savedProspect) => {
                const isCreating = !savedProspect.id;
                const originalProspect = isCreating ? null : prospects.find(p => p.id === savedProspect.id);
                if (!isCreating && savedProspect.status === 'Venda' && originalProspect?.status !== 'Proposta Enviada') {
                    alert('Não é possível alterar o status para "Venda" sem antes estar em "Proposta Enviada".'); return false;
                }
                
                const dataToSave = { ...savedProspect, userId: user.id };
                let error, changeLog = [];

                if (isCreating) {
                    delete dataToSave.id;
                    ({ error } = await supabase.from('CRM DADOS').insert(dataToSave));
                } else {
                    for (const key in savedProspect) { if (originalProspect && originalProspect[key] !== savedProspect[key]) { changeLog.push({ field: key, oldValue: originalProspect[key], newValue: savedProspect[key], timestamp: new Date().toISOString() }); } }
                    const updatedData = { ...savedProspect, editHistory: [...(originalProspect.editHistory || []), ...changeLog]};
                    delete updatedData.id;
                    ({ error } = await supabase.from('CRM DADOS').update(updatedData).eq('id', savedProspect.id));
                }

                if (error) { alert("Erro ao salvar prospect: " + error.message); return false; }

                if (savedProspect.status === 'Venda' && originalProspect?.status !== 'Venda') triggerCelebration();
                await fetchProspects();
                return true;
            };
            
            // ... (resto dos seus handlers)

            // Renderização
            if (isLoading) return <div className="loading-container text-2xl font-semibold">Carregando...</div>;
            
            if (!user) {
                return (
                    <div className="login-container">
                        <form onSubmit={handleLogin} className="p-8 bg-white rounded-lg shadow-xl w-full max-w-sm space-y-4">
                             <h2 className="text-2xl font-bold text-center text-gray-800">NG PROSPECT</h2>
                             <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="E-mail" required className="w-full p-3 border rounded text-gray-800" />
                             <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Senha" required className="w-full p-3 border rounded text-gray-800" />
                             <button type="submit" className="w-full p-3 bg-brand-coral text-white rounded font-bold hover:bg-brand-coral-dark">Entrar</button>
                        </form>
                    </div>
                );
            }

            const NavButton = ({ viewName, icon, children }) => ( <button onClick={() => setView(viewName)} className={`flex items-center space-x-2 px-3 py-2 rounded-lg transition-colors duration-200 text-sm ${view === viewName ? 'text-brand-coral' : 'text-brand-text-light hover:bg-white/10'}`}>{icon}<span className="font-semibold lowercase">{children}</span></button> );

            const renderView = () => {
                const props = { prospects, users, tasks, onStatusChange: handleStatusChange, onCardClick: handleCardClick, handleDragStart: (e, id) => e.dataTransfer.setData("prospectId", id), handleSelectProspect, selectedIds, onTaskToggle: () => {} };
                switch (view) {
                    case 'kanban': return <KanbanView {...props} />;
                    case 'list': return <ListView {...props} />;
                    case 'tasks': return <TasksView {...props} />;
                    case 'dashboard': default: return <DashboardView {...props} />;
                }
            };
            
            return (
                <div className="h-screen w-screen flex flex-col bg-brand-base-gray dark:bg-[#0f172a]">
                    {showConfetti && <Confetti />}
                    <ProspectModal isOpen={isModalOpen} onClose={handleCloseModal} prospect={selectedProspect} users={users} tasks={tasks} onSave={handleSaveProspect} onRegisterCadence={() => {}} onAddTask={() => {}}/>
                    <ImportModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onImportSuccess={() => {}} />
                    <header className="bg-brand-dark-blue p-4 flex justify-between items-center border-b border-white/10 flex-shrink-0">
                        <div className="flex items-center">
                           <svg className="h-10 w-auto" viewBox="0 0 160 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M68.4418 0.441406L103.111 47.108V0.441406H115.541V97.382H103.111V50.1583L68.4418 97.382H54.0336L19.0141 50.1583V97.382H6.58398V0.441406H19.0141L54.0336 47.108L68.4418 0.441406Z" fill="#F75E67"/>
                                <text x="10" y="90" fontFamily="Poppins, sans-serif" fontSize="30" fontWeight="300" fill="#E2E8F0">grupo</text>
                           </svg>
                        </div>
                        <nav className="flex items-center space-x-1 bg-white/5 p-1 rounded-lg">
                           <NavButton viewName="dashboard" icon={Icons.dashboard}>dashboard</NavButton>
                           <NavButton viewName="kanban" icon={Icons.kanban}>kanban</NavButton>
                           <NavButton viewName="list" icon={Icons.list}>lista</NavButton>
                           <NavButton viewName="tasks" icon={Icons.tasks}>tarefas</NavButton>
                        </nav>
                        <div className="flex items-center space-x-4">
                            <useTheme.Consumer>
                                {({ theme, toggleTheme }) => (
                                    <button onClick={toggleTheme} className="p-2 rounded-full text-brand-text-light hover:bg-white/10 transition-colors">
                                        {theme === 'light' ? Icons.moon : Icons.sun}
                                    </button>
                                )}
                            </useTheme.Consumer>
                            <button onClick={handleNewProspectClick} className="px-4 py-2 bg-brand-coral text-white rounded-lg font-semibold hover:bg-brand-coral-dark shadow-sm hover:shadow-lg transition-all lowercase">novo contato</button>
                            <button onClick={() => setIsImportModalOpen(true)} className="px-4 py-2 bg-white/10 text-brand-text-light rounded-lg font-semibold hover:bg-white/20 transition-all lowercase">importar</button>
                            <button onClick={handleLogout} className="px-4 py-2 bg-white/10 text-brand-text-light rounded-lg font-semibold hover:bg-white/20 transition-all lowercase">Sair</button>
                            <span className="text-3xl">{profile?.avatar || '👤'}</span>
                        </div>
                    </header>
                    <main className="flex-1 overflow-y-auto">{renderView()}</main>
                </div>
            );
        }

        // --- PONTO DE ENTRADA DO REACT ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ThemeProvider>
               <App />
            </ThemeProvider>
        );
    </script>
</body>
</html>
