<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NG PROSPECT</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark-blue': '#202C6D',
                        'brand-coral': '#F75E67',
                        'brand-coral-dark': '#E65358',
                        'brand-base-white': '#FFFFFF',
                        'brand-base-gray': '#F5F5F5',
                        'brand-text-dark': '#1a202c',
                        'brand-text-light': '#E2E8F0',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F5F5F5; color: #1a202c; }
        .kanban-board { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; }
        .kanban-column { min-width: 300px; max-width: 320px; flex-shrink: 0; }
        .kanban-column.drag-over { border-color: #F75E67; border-style: dashed; }
        .prospect-card.dragging { opacity: 0.5; transform: rotate(3deg); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%; }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .login-container, .loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #202C6D; }
        .loading-container { color: white; font-size: 1.5rem; font-weight: 600; }
        .login-form { display: flex; flex-direction: column; gap: 1rem; padding: 2rem; background-color: #FFFFFF; border-radius: 8px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); width: 90%; max-width: 380px; }
        .login-form h2 { color: #202C6D; text-align: center; font-size: 1.75rem; font-weight: 700; }
        .login-form input, .modal-content input, .modal-content select { width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 1rem; }
        .login-form button, .modal-content button { padding: 0.75rem; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .login-form button { background-color: #F75E67; color: white; }
        .login-form button:hover { background-color: #E65358; }
    </style>
</head>

<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js" defer></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" defer></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 1. CONFIGURAÇÃO E CONSTANTES ---
        const supabaseUrl = 'https://ekzjsqheinpvebjfjims.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrempzcWhlaW5wdmViamZqaW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5OTIzNDMsImV4cCI6MjA2NjU2ODM0M30.HrBFnV6ve6po2GeitFXs55ensNljsXs-1aSVwdKHDDA';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        const KANBAN_STAGES = ['Novo', 'Contato Inicial', 'Contato com Decisor', 'Proposta Enviada', 'Venda', 'Perdido', 'No Show'];

        // --- 2. COMPONENTES DE UI ---

        function ProspectCard({ prospect, onDragStart }) {
            return (
                <div 
                    draggable="true"
                    onDragStart={(e) => onDragStart(e, prospect.id)}
                    className="prospect-card bg-white p-4 rounded-lg shadow-sm mb-4 cursor-grab active:cursor-grabbing"
                >
                    <h4 className="font-bold text-brand-text-dark">{prospect.name}</h4>
                    <p className="text-gray-600 text-sm">{prospect.contactName}</p>
                    <p className="text-green-600 font-semibold mt-2">
                        {new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(prospect.value || 0)}
                    </p>
                </div>
            );
        }
        
        function ProspectModal({ isOpen, onClose, onSave, prospectToEdit }) {
            const [name, setName] = useState('');
            const [contactName, setContactName] = useState('');
            const [value, setValue] = useState(0);

            useEffect(() => {
                if (prospectToEdit) {
                    setName(prospectToEdit.name || '');
                    setContactName(prospectToEdit.contactName || '');
                    setValue(prospectToEdit.value || 0);
                } else {
                    setName('');
                    setContactName('');
                    setValue(0);
                }
            }, [prospectToEdit, isOpen]);

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ id: prospectToEdit?.id, name, contactName, value: Number(value) });
                onClose();
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <h3 className="text-2xl font-bold mb-4">{prospectToEdit ? 'Editar Prospect' : 'Adicionar Prospect'}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Nome da Empresa</label>
                                <input type="text" value={name} onChange={e => setName(e.target.value)} required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Nome do Contato</label>
                                <input type="text" value={contactName} onChange={e => setContactName(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Valor da Proposta</label>
                                <input type="number" value={value} onChange={e => setValue(e.target.value)} />
                            </div>
                            <div className="flex justify-end gap-4 pt-4">
                                <button type="button" onClick={onClose} className="bg-gray-200 text-gray-800">Cancelar</button>
                                <button type="submit" className="bg-brand-coral text-white">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- 3. COMPONENTE PRINCIPAL DA APLICAÇÃO ---
        function App() {
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [prospects, setProspects] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);

            useEffect(() => {
                const checkUserSession = async () => {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    setUser(session?.user ?? null);
                    setIsLoading(false);
                };
                checkUserSession();
                const { data: authListener } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                    setUser(session?.user ?? null);
                    setIsLoading(false);
                });
                return () => { authListener.subscription.unsubscribe(); };
            }, []);

            useEffect(() => { if (user) fetchData(); }, [user]);

            const fetchData = async () => {
                const { data, error } = await supabaseClient.from('prospects').select('*').order('name', { ascending: true });
                if (error) console.error("Erro ao buscar dados:", error);
                else setProspects(data);
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                try {
                    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                } catch (error) {
                    alert(error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleLogout = async () => { await supabaseClient.auth.signOut(); };

            const handleDragStart = (e, prospectId) => {
                e.dataTransfer.setData("prospectId", prospectId);
            };
            
            const handleDrop = async (e, newStatus) => {
                const prospectId = e.dataTransfer.getData("prospectId");
                e.currentTarget.classList.remove('drag-over');

                // Atualiza o estado local para uma UI mais rápida
                setProspects(prevProspects => prevProspects.map(p => 
                    p.id == prospectId ? { ...p, status: newStatus } : p
                ));

                // Atualiza no banco de dados em segundo plano
                const { error } = await supabaseClient.from('prospects').update({ status: newStatus }).eq('id', prospectId);
                if (error) {
                    console.error("Erro ao atualizar status:", error);
                    alert("Não foi possível atualizar o prospect. A página será recarregada.");
                    fetchData(); // Reverte a mudança local se houver erro
                }
            };
            
            const handleSaveProspect = async (prospectData) => {
                const dataToSave = {
                    ...prospectData,
                    userId: user.id // Garante que o prospect seja associado ao usuário logado
                };
                delete dataToSave.id; // Remove o ID para inserção
                
                const { error } = await supabaseClient.from('prospects').insert([dataToSave]);

                if (error) {
                    console.error("Erro ao salvar prospect:", error);
                    alert("Falha ao salvar o prospect.");
                } else {
                    fetchData(); // Recarrega os dados para mostrar o novo prospect
                }
            };

            if (isLoading) { return <div className="loading-container">Carregando...</div>; }

            if (!user) {
                return (
                    <div className="login-container">
                        <form className="login-form" onSubmit={handleLogin}>
                            <h2>NG PROSPECT</h2>
                            <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="E-mail" required />
                            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Senha" required />
                            <button type="submit">Entrar</button>
                        </form>
                    </div>
                );
            }

            return (
                <div className="h-screen w-screen flex flex-col">
                    <header className="flex justify-between items-center p-4 bg-brand-base-white shadow-md flex-shrink-0">
                        <div>
                           <h1 className="font-bold text-xl text-brand-dark-blue">NG Prospect</h1>
                           <p className="text-sm text-gray-600">{user.email}</p>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={() => setIsModalOpen(true)} className="bg-brand-coral text-white px-4 py-2 rounded-lg font-semibold hover:bg-brand-coral-dark transition-colors">Adicionar Prospect</button>
                            <button onClick={handleLogout} className="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Sair</button>
                        </div>
                    </header>
                    
                    <main className="flex-1 p-4 sm:p-6 overflow-hidden">
                        <div className="kanban-board custom-scrollbar h-full">
                            {KANBAN_STAGES.map(stage => (
                                <div 
                                    key={stage}
                                    className="kanban-column bg-gray-100 rounded-lg p-3 border-2 border-transparent"
                                    onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }}
                                    onDragLeave={(e) => e.currentTarget.classList.remove('drag-over')}
                                    onDrop={(e) => handleDrop(e, stage)}
                                >
                                    <h3 className="font-bold text-lg mb-4 px-1 text-brand-text-dark">{stage}</h3>
                                    <div className="prospect-list space-y-4">
                                        {prospects
                                            .filter(p => p.status === stage)
                                            .map(p => <ProspectCard key={p.id} prospect={p} onDragStart={handleDragStart} />)
                                        }
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>

                    <ProspectModal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)}
                        onSave={handleSaveProspect}
                    />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
