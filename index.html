<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectSphere Prospect CRM - Vers√£o Completa</title>
    
    <!-- Tailwind CSS para estiliza√ß√£o r√°pida e moderna -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React e Babel para rodar o JSX diretamente no navegador -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS (xlsx) para ler arquivos CSV e Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Google Fonts para uma melhor tipografia -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .kanban-column.drag-over { background-color: #e0f2fe; border-color: #38bdf8; }
        .prospect-card.dragging { opacity: 0.5; transform: rotate(3deg); }
        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .confetti { position: absolute; width: 10px; height: 10px; opacity: 0.7; animation: fall 4s linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, Fragment } = React;

        // --- DADOS MOCKADOS E CONSTANTES ---
        const initialUsers = [ { id: 1, name: 'Sofia', avatar: 'üë©‚Äçüíª' }, { id: 2, name: 'Carlos', avatar: 'üë®‚Äçüíº' }, { id: 3, name: 'Ana', avatar: 'üë©‚Äçüî¨' } ];
        const KANBAN_STAGES = ['Novo', 'Contato Inicial', 'Contato com Decisor', 'Proposta Enviada', 'Venda', 'Perdido', 'No Show'];
        const initialProspects = [
            { id: 1, name: 'Tech Solutions Inc.', contactName: 'Roberto Silva', value: 15000, status: 'Novo', userId: 1, email: 'roberto.silva@techsolutions.com', phone: '(11) 98765-4321', editHistory: [] },
            { id: 2, name: 'Inova Marketing Digital', contactName: 'Mariana Costa', value: 8000, status: 'Contato Inicial', userId: 2, email: 'mariana.costa@inova.com', phone: '(21) 91234-5678', editHistory: [] },
            { id: 3, name: 'Global Logistics', contactName: 'Fernando Almeida', value: 25000, status: 'Contato com Decisor', userId: 1, email: 'fernando.a@globallog.net', phone: '(31) 99988-7766', editHistory: [] },
            { id: 4, name: 'Advocacia & Associados', contactName: 'Beatriz Lima', value: 22000, status: 'Venda', userId: 2, email: 'beatriz.lima@adv.com', phone: '(61) 96655-4433', editHistory: [] },
            { id: 5, name: 'Fast Burger', contactName: 'Ricardo Souza', value: 12000, status: 'Proposta Enviada', userId: 1, email: 'ricardo@fast.com', phone: '(51) 97766-5544', editHistory: [] },
            { id: 6, name: 'Web Dev Co.', contactName: 'Pedro Martins', value: 9500, status: 'Perdido', userId: 3, email: 'pedro@webdev.com', phone: '(41) 91122-3344', editHistory: [] },
            { id: 7, name: 'Consultoria X', contactName: 'L√∫cia Alves', value: 33000, status: 'No Show', userId: 2, email: 'lucia@consultax.com', phone: '(21) 93322-1100', editHistory: [] },
        ];
        const initialTasks = [ 
            { id: 1, prospectId: 2, userId: 2, description: "Cad√™ncia: Liga√ß√£o, Conex√£o", dueDate: '2025-06-26', completed: true, type: 'Cad√™ncia' },
            { id: 2, prospectId: 1, userId: 1, description: "Preparar proposta comercial", dueDate: '2025-07-02', completed: false, type: 'Follow-up' },
        ];
        const CRM_FIELDS = ['name', 'contactName', 'email', 'phone', 'value', 'status'];
        const CRM_FIELD_LABELS = { name: 'Nome da Empresa', contactName: 'Nome do Contato', email: 'E-mail', phone: 'Telefone', value: 'Valor da Proposta', status: 'Status' };
        
        const Icons = {
            dashboard: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>,
            kanban: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>,
            list: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            tasks: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            upload: <svg xmlns="http://www.w3.org/2000/svg" className="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h1.586A2 2 0 0114.172 4.414l.707.707A2 2 0 0016.586 6H17a4 4 0 014 4v5a4 4 0 01-4 4H7z M12 12a3 3 0 100-6 3 3 0 000 6z" /></svg>,
            check: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>,
            cross: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>,
            money: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            contact: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 18a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2"/><rect x="3" y="4" width="18" height="18" rx="2"/><circle cx="12" cy="10" r="2"/></svg>,
            phone: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            interactions: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>,
            edit: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg>,
            taskLog: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>,
            search: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" /></svg>,
            arrow: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" /></svg>,
            calendar: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
        };
        
        // --- COMPONENTES ---

        function Confetti() {
            const confettiCount = 150; const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];
            const particles = useMemo(() => Array.from({ length: confettiCount }).map((_, i) => ({ id: i, color: colors[Math.floor(Math.random() * colors.length)], left: `${Math.random() * 100}%`, animationDelay: `${Math.random() * 4}s`, duration: `${2 + Math.random() * 2}s`, transform: `rotate(${Math.random() * 360}deg)` })), []);
            return (<div className="confetti-container">{particles.map(p => (<div key={p.id} className="confetti" style={{ backgroundColor: p.color, left: p.left, animationDuration: p.duration, animationDelay: p.animationDelay, transform: p.transform }}/>))}</div>);
        }

        function ProspectCard({ prospect, onDragStart, onCardClick, contactCount }) {
            return (
                <div draggable="true" onDragStart={(e) => { onDragStart(e, prospect.id); e.currentTarget.classList.add('dragging'); }} onDragEnd={(e) => e.currentTarget.classList.remove('dragging')} onClick={() => onCardClick(prospect)}
                    className="bg-white rounded-lg shadow-md p-4 mb-4 border-l-4 border-blue-500 hover:shadow-xl transition-shadow duration-300 cursor-pointer prospect-card" >
                    <h3 className="font-bold text-gray-800 truncate">{prospect.name}</h3>
                    <div className="text-sm text-gray-500 mt-2 space-y-1.5">
                        <p className="flex items-center"><span className="mr-2">{Icons.contact}</span>{prospect.contactName}</p>
                        <p className="flex items-center font-medium text-gray-600"><span className="mr-2 text-green-500">{Icons.phone}</span>{prospect.phone}</p>
                        <p className="flex items-center"><span className="mr-2">{Icons.money}</span>{prospect.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        <p className="flex items-center font-semibold"><span className="mr-2 text-blue-500">{Icons.interactions}</span>{contactCount} Contatos</p>
                    </div>
                </div>
            );
        }

        function ProspectModal({ isOpen, onClose, prospect, users, tasks, onSave, onRegisterCadence, onAddTask }) {
            if (!isOpen || !prospect) return null;
            const [editedData, setEditedData] = useState(prospect);
            const [selectedActions, setSelectedActions] = useState([]);
            const [newTaskDesc, setNewTaskDesc] = useState('');
            const [newTaskDate, setNewTaskDate] = useState('');
            useEffect(() => { setEditedData(prospect); setSelectedActions([]); setNewTaskDesc(''); setNewTaskDate(''); }, [prospect]);
            const handleChange = (e) => { const { name, value } = e.target; setEditedData(prev => ({...prev, [name]: name === 'value' ? parseFloat(value) || 0 : value })); };
            const handleSave = () => { const changeLog = []; for (const key in editedData) { if (prospect[key] !== editedData[key]) { changeLog.push({ field: key, oldValue: prospect[key], newValue: editedData[key], timestamp: new Date().toISOString() }); } } onSave(editedData, changeLog); onClose(); };
            const handleActionToggle = (actionType) => { setSelectedActions(prev => prev.includes(actionType) ? prev.filter(a => a !== actionType) : [...prev, actionType]); };
            const handleRegisterClick = () => { if(selectedActions.length === 0) { alert('Selecione pelo menos uma a√ß√£o para registrar.'); return; } onRegisterCadence(prospect, selectedActions); setSelectedActions([]); };
            const timeline = useMemo(() => { const pTasks = tasks.filter(t => t.prospectId === prospect.id).map(t => ({...t, type: 'task'})); const pHistory = (prospect.editHistory || []).map(h => ({...h, type: 'edit'})); return [...pTasks, ...pHistory].sort((a,b) => new Date(b.dueDate || b.timestamp) - new Date(a.dueDate || a.timestamp)); }, [tasks, prospect]);
            const handleScheduleTask = () => { if(!newTaskDesc || !newTaskDate) { alert("Por favor, preencha a descri√ß√£o e a data da tarefa."); return; } onAddTask(prospect, newTaskDesc, newTaskDate); setNewTaskDesc(''); setNewTaskDate(''); };
            const QuickActionButton = ({ type, color, children }) => { const isSelected = selectedActions.includes(type); return (<button onClick={() => handleActionToggle(type)} className={`px-3 py-1.5 text-sm font-semibold rounded-md transition-all duration-200 border-2 ${isSelected ? `${color.selectedBg} ${color.selectedText} ${color.selectedBorder}` : `${color.bg} text-white hover:${color.hoverBg}`}`}>{children}</button>) };
            const actionColors = { 'Liga√ß√£o': { bg: 'bg-violet-500', hoverBg: 'bg-violet-600', selectedBg: 'bg-violet-100', selectedText: 'text-violet-700', selectedBorder: 'border-violet-500' }, 'Conex√£o': { bg: 'bg-green-500', hoverBg: 'bg-green-600', selectedBg: 'bg-green-100', selectedText: 'text-green-700', selectedBorder: 'border-green-500' }, 'Decisor': { bg: 'bg-orange-500', hoverBg: 'bg-orange-600', selectedBg: 'bg-orange-100', selectedText: 'text-orange-700', selectedBorder: 'border-orange-500' }, 'Reuni√£o Marcada': { bg: 'bg-indigo-500', hoverBg: 'bg-indigo-600', selectedBg: 'bg-indigo-100', selectedText: 'text-indigo-700', selectedBorder: 'border-indigo-500' }, 'Reuni√£o Realizada': { bg: 'bg-teal-500', hoverBg: 'bg-teal-600', selectedBg: 'bg-teal-100', selectedText: 'text-teal-700', selectedBorder: 'border-teal-500' }, 'Venda': { bg: 'bg-amber-400', hoverBg: 'bg-amber-500', selectedBg: 'bg-amber-100', selectedText: 'text-amber-700', selectedBorder: 'border-amber-500' }, };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center"><h2 className="text-xl font-bold text-gray-800">{prospect.name}</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div>
                        <div className="flex-1 flex overflow-hidden">
                            <div className="w-1/2 p-6 border-r overflow-y-auto custom-scrollbar"><div className="space-y-4"><div><label className="block text-sm font-medium text-gray-700">Nome da Empresa</label><input type="text" name="name" value={editedData.name} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" /></div><div><label className="block text-sm font-medium text-gray-700">Nome do Contato</label><input type="text" name="contactName" value={editedData.contactName} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" /></div><div><label className="block text-sm font-medium text-gray-700">E-mail</label><input type="email" name="email" value={editedData.email || ''} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" /></div><div><label className="block text-sm font-medium text-gray-700">Telefone</label><input type="tel" name="phone" value={editedData.phone || ''} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" /></div><div><label className="block text-sm font-medium text-gray-700">Valor</label><input type="number" name="value" value={editedData.value} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" /></div><div><label className="block text-sm font-medium text-gray-700">Status</label><select name="status" value={editedData.status} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">{KANBAN_STAGES.map(s => <option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-medium text-gray-700">Respons√°vel</label><select name="userId" value={editedData.userId} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">{users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}</select></div><button onClick={handleSave} className="w-full mt-2 px-4 py-2 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700">Salvar Altera√ß√µes</button></div>
                               <div className="mt-6 pt-6 border-t"><h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-4">{Icons.calendar} Tarefas de Follow-up</h3><div className="space-y-3"><input type="text" placeholder="Descreva a pr√≥xima a√ß√£o..." value={newTaskDesc} onChange={(e) => setNewTaskDesc(e.target.value)} className="block w-full border border-gray-300 rounded-md shadow-sm p-2" /><input type="date" value={newTaskDate} onChange={(e) => setNewTaskDate(e.target.value)} className="block w-full border border-gray-300 rounded-md shadow-sm p-2" /><button onClick={handleScheduleTask} disabled={!newTaskDesc || !newTaskDate} className="w-full px-4 py-2 bg-violet-500 text-white rounded-md font-semibold hover:bg-violet-600 disabled:bg-gray-400">Agendar</button></div></div>
                            </div>
                            <div className="w-1/2 p-6 overflow-y-auto custom-scrollbar"><h3 className="text-lg font-semibold text-gray-800 mb-4">Hist√≥rico de Atividades</h3><ul className="space-y-4">{timeline.map((item, index) => (<li key={index} className="flex items-start space-x-3"><div className="mt-1">{item.type === 'edit' ? Icons.edit : Icons.taskLog}</div><div><p className="text-sm font-medium text-gray-700">{item.type === 'edit' ? `Campo '${item.field}' alterado` : item.description}</p><p className="text-xs text-gray-500">{item.type === 'edit' ? `de '${item.oldValue}' para '${item.newValue}'` : `Tarefa ${item.completed ? 'conclu√≠da' : 'pendente'}`}</p><p className="text-xs text-gray-400 mt-0.5">{new Date(item.dueDate || item.timestamp).toLocaleString('pt-BR')}</p></div></li>))}</ul></div>
                        </div>
                        <div className="p-4 bg-slate-50 border-t"><h3 className="text-sm font-medium text-gray-600 mb-2">A√ß√µes R√°pidas (Cad√™ncia Inteligente)</h3><div className="flex flex-wrap gap-2 items-center"><QuickActionButton type="Liga√ß√£o" color={actionColors['Liga√ß√£o']}>Liga√ß√£o</QuickActionButton><QuickActionButton type="Conex√£o" color={actionColors['Conex√£o']}>Conex√£o</QuickActionButton><QuickActionButton type="Decisor" color={actionColors['Decisor']}>Decisor</QuickActionButton><QuickActionButton type="Reuni√£o Marcada" color={actionColors['Reuni√£o Marcada']}>Reuni√£o Marcada</QuickActionButton><QuickActionButton type="Reuni√£o Realizada" color={actionColors['Reuni√£o Realizada']}>Reuni√£o Realizada</QuickActionButton><QuickActionButton type="Venda" color={actionColors['Venda']}>Venda</QuickActionButton><div className="flex-grow flex items-center justify-end gap-4"><span className="text-sm text-gray-600 font-medium">{selectedActions.length} a√ß√£o(√µes) selecionada(s) = 1 cad√™ncia</span><button onClick={handleRegisterClick} className="px-4 py-2 bg-violet-600 text-white rounded-md font-semibold hover:bg-violet-700 disabled:bg-gray-400" disabled={selectedActions.length === 0}>Registar A√ß√µes</button></div></div></div>
                    </div>
                </div>
            );
        }
        function ImportModal({ isOpen, onClose, onImportSuccess }) {
            const [step, setStep] = useState(1); const [fileHeaders, setFileHeaders] = useState([]); const [fileData, setFileData] = useState([]); const [mapping, setMapping] = useState({}); const [importReport, setImportReport] = useState(null);
            const resetState = () => { setStep(1); setFileHeaders([]); setFileData([]); setMapping({}); setImportReport(null); };
            const handleFileDrop = (e) => { e.preventDefault(); const file = e.dataTransfer.files[0]; processFile(file); };
            const handleFileSelect = (e) => { const file = e.target.files[0]; processFile(file); };
            const processFile = (file) => { if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); const headers = json[0] || []; const records = json.slice(1).map(row => { let record = {}; headers.forEach((header, i) => record[header] = row[i]); return record; }); setFileHeaders(headers); setFileData(records); autoMapColumns(headers); setStep(2); }; reader.readAsArrayBuffer(file); };
            const autoMapColumns = (headers) => { const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9]/gi, ''); let newMapping = {}; headers.forEach(header => { const normalizedHeader = normalize(header); const match = CRM_FIELDS.find(field => normalize(CRM_FIELD_LABELS[field]).includes(normalizedHeader)); newMapping[header] = match || ''; }); setMapping(newMapping); };
            const handleMappingChange = (header, crmField) => { setMapping(prev => ({...prev, [header]: crmField })); };
            const handleConfirmImport = () => { onImportSuccess(fileData, mapping); setImportReport({ success: fileData.length, failed: 0, duplicates: 0 }); setStep(3); };
            const handleClose = () => { resetState(); onClose(); };
            return ( isOpen && (<div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"><div className="bg-white rounded-lg shadow-2xl w-full max-w-3xl"><div className="p-4 border-b flex justify-between items-center"><h2 className="text-xl font-bold text-gray-800">Importar Contatos - Passo {step}/3</h2><button onClick={handleClose} className="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div>
                {step === 1 && (<div onDrop={handleFileDrop} onDragOver={(e) => e.preventDefault()} className="p-8 border-dashed border-2 border-gray-300 m-8 rounded-lg text-center">{Icons.upload}<p className="mt-2 text-sm text-gray-600">Arraste e solte o seu ficheiro .csv ou .xlsx aqui</p><p className="text-xs text-gray-500 mt-1">ou</p><label htmlFor="file-upload" className="cursor-pointer mt-2 inline-block bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600">Selecione um Ficheiro</label><input id="file-upload" name="file-upload" type="file" className="sr-only" onChange={handleFileSelect} accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" /><div className="mt-6 p-4 bg-slate-100 bg-opacity-75 rounded-lg text-left"><p className="text-xs font-semibold text-gray-500 mb-2">Sequ√™ncia recomendada de colunas:</p><div className="grid grid-cols-3 sm:grid-cols-5 gap-2 text-center text-xs"><span className="bg-slate-200 p-2 rounded truncate font-medium">Nome da Empresa</span><span className="bg-slate-200 p-2 rounded truncate font-medium">Nome do Contato</span><span className="bg-slate-200 p-2 rounded truncate font-medium">E-mail</span><span className="bg-slate-200 p-2 rounded truncate font-medium">Telefone</span><span className="bg-slate-200 p-2 rounded truncate font-medium">Valor</span></div></div></div>)}
                {step === 2 && (<div className="p-8"><h3 className="font-semibold text-gray-700 mb-4">Mapeie as colunas do seu ficheiro com os campos do CRM:</h3><div className="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-4">{fileHeaders.map(header => (<div key={header} className="grid grid-cols-2 gap-4 items-center"><span className="font-medium text-gray-600 bg-gray-100 p-2 rounded-md truncate">{header}</span><select value={mapping[header] || ''} onChange={(e) => handleMappingChange(header, e.target.value)} className="block w-full border border-gray-300 rounded-md shadow-sm p-2"><option value="">Ignorar esta coluna</option>{CRM_FIELDS.map(field => <option key={field} value={field}>{CRM_FIELD_LABELS[field]}</option>)}</select></div>))}</div><div className="mt-8 flex justify-end"><button onClick={handleConfirmImport} disabled={!Object.values(mapping).some(v => v === 'name' || v === 'contactName')} className="px-6 py-2 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 disabled:bg-gray-400">Importar</button></div></div>)}
                {step === 3 && (<div className="p-8 text-center"><h3 className="text-2xl font-bold text-green-600 mb-4">Importa√ß√£o Conclu√≠da!</h3><div className="space-y-2 text-lg text-gray-700"><p className="flex items-center justify-center">{Icons.check} {importReport.success} contatos importados com sucesso.</p><p className="flex items-center justify-center">{Icons.cross} {importReport.failed} contatos falharam.</p></div><button onClick={handleClose} className="mt-8 px-6 py-2 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700">Fechar</button></div>)}
            </div></div>) );
        }
        function KanbanView({ prospects, users, tasks, onStatusChange, onCardClick }) {
            const handleDragStart = (e, prospectId) => { e.dataTransfer.setData("prospectId", prospectId) };
            const handleDragOver = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over') };
            const handleDragLeave = (e) => e.currentTarget.classList.remove('drag-over');
            const handleDrop = (e, newStatus) => { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); const prospectId = e.dataTransfer.getData("prospectId"); onStatusChange(parseInt(prospectId), newStatus); };
            const prospectsByStage = useMemo(() => { const grouped = {}; KANBAN_STAGES.forEach(stage => grouped[stage] = []); prospects.forEach(p => grouped[p.status]?.push(p)); return grouped; }, [prospects]);
            return (<div className="flex-1 p-4 sm:p-6 lg:p-8 overflow-x-auto custom-scrollbar"><div className="flex gap-6 min-w-max h-full">{KANBAN_STAGES.map(stage => (<div key={stage} className="bg-slate-100 rounded-xl w-80 flex-shrink-0 flex flex-col kanban-column border-2 border-transparent transition-colors" onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={(e) => handleDrop(e, stage)}><div className={`p-4 border-b-2 border-slate-200 ${stage === 'Venda' ? 'bg-green-200' : ''} ${stage === 'Perdido' || stage === 'No Show' ? 'bg-red-200' : ''}`}><h2 className="font-bold text-gray-700">{stage} <span className="text-sm font-medium text-gray-500">{prospectsByStage[stage].length}</span></h2></div><div className="p-4 h-full overflow-y-auto custom-scrollbar">{prospectsByStage[stage].map(prospect => { const contactCount = tasks.filter(t => t.prospectId === prospect.id && t.completed && t.type === 'Cad√™ncia').length; return <ProspectCard key={prospect.id} prospect={prospect} onCardClick={onCardClick} contactCount={contactCount} onDragStart={handleDragStart} />; })}</div></div>))}</div></div>);
        }
        function ListView({ prospects, users, onCardClick, tasks, onSelect, selectedIds }) {
            const [filter, setFilter] = useState(''); const [collapsedStages, setCollapsedStages] = useState({});
            const toggleStage = (stage) => { setCollapsedStages(prev => ({ ...prev, [stage]: !prev[stage] })); };
            const stageColors = { 'Novo': 'bg-gray-500', 'Contato Inicial': 'bg-blue-500', 'Contato com Decisor': 'bg-purple-500', 'Proposta Enviada': 'bg-orange-500', 'Venda': 'bg-green-500', 'Perdido': 'bg-red-500', 'No Show': 'bg-red-700' };
            const filteredProspects = useMemo(() => prospects.filter(p => p.name.toLowerCase().includes(filter.toLowerCase())), [prospects, filter]);
            const prospectsByStage = useMemo(() => { const grouped = {}; KANBAN_STAGES.forEach(stage => grouped[stage] = []); filteredProspects.forEach(p => grouped[p.status]?.push(p)); return grouped; }, [filteredProspects]);
            return (<div className="flex-1 p-4 sm:p-6 lg:p-8 flex flex-col"><div className="mb-6"><div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">{Icons.search}</div><input type="text" placeholder="Filtrar por nome do prospect..." value={filter} onChange={(e) => setFilter(e.target.value)} className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" /></div></div><div className="flex-1 overflow-y-auto custom-scrollbar pr-2"><div className="space-y-4">{KANBAN_STAGES.map(stage => { const prospectsInStage = prospectsByStage[stage]; const isCollapsed = collapsedStages[stage]; if(filter && prospectsInStage.length === 0) return null; return (<div key={stage} className="bg-white rounded-lg shadow-sm"><div className="p-3 flex items-center justify-between cursor-pointer" onClick={() => toggleStage(stage)}><div className="flex items-center gap-3"><span className={`${isCollapsed ? '' : 'rotate-90'}`}>{Icons.arrow}</span><span className={`px-3 py-1 text-xs font-bold text-white rounded-full ${stageColors[stage]}`}>{stage}</span><span className="text-sm font-semibold text-gray-600">{prospectsInStage.length}</span></div></div>{!isCollapsed && (<div className="border-t border-gray-200">{prospectsInStage.length > 0 ? (<table className="min-w-full"><tbody className="divide-y divide-gray-200">{prospectsInStage.map(prospect => { const user = users.find(u => u.id === prospect.userId); const contactCount = tasks.filter(t => t.prospectId === prospect.id && t.completed && t.type === 'Cad√™ncia').length; return (<tr key={prospect.id} className="hover:bg-gray-50"><td className="px-4 py-3"><input type="checkbox" className="h-4 w-4 rounded border-gray-300 text-blue-600" checked={selectedIds.includes(prospect.id)} onChange={() => onSelect(prospect.id)} /></td><td className="px-4 py-3 whitespace-nowrap cursor-pointer" onClick={() => onCardClick(prospect)}><div className="text-sm font-medium text-gray-900">{prospect.name}</div><div className="text-sm text-gray-500">{prospect.contactName}</div></td><td className="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{prospect.phone}</td><td className="px-4 py-3 whitespace-nowrap text-sm font-bold text-green-600">{prospect.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td><td className="px-4 py-3 whitespace-nowrap text-sm text-blue-600 font-semibold">{contactCount} contatos</td><td className="px-4 py-3 whitespace-nowrap text-sm text-gray-800"><span className="flex items-center" title={`Respons√°vel: ${user.name}`}><span className="text-lg mr-2">{user.avatar}</span>{user.name}</span></td></tr>); })}</tbody></table>) : <p className="px-6 py-4 text-sm text-gray-500">Nenhum prospect nesta etapa.</p>}</div>)}</div>); })}</div></div></div>);
        }
        function TasksView({ tasks, prospects, users, onTaskToggle, onCardClick }) {
            const openTasks = tasks.filter(t => !t.completed && t.type !== 'Cad√™ncia').sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            return(<div className="flex-1 p-4 sm:p-6 lg:p-8"><h1 className="text-2xl font-bold text-gray-800 mb-6">Minhas Tarefas</h1><div className="space-y-4">{openTasks.length === 0 && <p className="text-gray-500">Nenhuma tarefa pendente. Bom trabalho!</p>}{openTasks.map(task => { const prospect = prospects.find(p => p.id === task.prospectId); const user = users.find(u => u.id === task.userId); const isOverdue = new Date(task.dueDate) < new Date() && !task.completed; return (<div key={task.id} onClick={() => prospect && onCardClick(prospect)} className="bg-white rounded-lg shadow-md p-4 flex items-center justify-between hover:shadow-lg transition-shadow cursor-pointer"><div className="flex items-center"><input type="checkbox" checked={task.completed} onClick={(e) => e.stopPropagation()} onChange={() => onTaskToggle(task.id)} className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"/><div className="ml-4"><p className="text-sm font-medium text-gray-800">{task.description}</p><p className="text-sm text-gray-500">Para: <span className="font-semibold">{prospect?.name || 'Prospect n√£o encontrado'}</span></p></div></div><div className="flex items-center space-x-4"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isOverdue ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>Vence em: {new Date(task.dueDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</span><span className="flex items-center text-gray-600" title={`Respons√°vel: ${user.name}`}><span className="text-lg">{user.avatar}</span></span></div></div>); })}</div></div>);
        }
        function DashboardView({ prospects, users, tasks }) {
            const ActivityKpiCard = ({ title, value, icon, iconBgColor }) => ( <div className="bg-white p-5 rounded-lg shadow-md flex items-center justify-between"><div><h3 className="text-sm font-medium text-gray-500">{title}</h3><p className="mt-1 text-3xl font-semibold text-gray-900">{value}</p></div><div className={`p-3 rounded-full ${iconBgColor}`}>{icon}</div></div> );
            const RankingPodium = ({ leaderboard }) => { const topThree = leaderboard.slice(0, 3); const podiumOrder = [1, 0, 2]; const podiumStyles = {0: { bgColor: 'bg-amber-400', height: 'h-40', rank: '1¬∫' }, 1: { bgColor: 'bg-slate-400', height: 'h-32', rank: '2¬∫' }, 2: { bgColor: 'bg-amber-600', height: 'h-24', rank: '3¬∫' },}; while(topThree.length < 3) { topThree.push({ id: `placeholder-${topThree.length}`, name: 'Vazio', avatar: 'üë§', score: 0 });} return (<div className="bg-white p-6 rounded-lg shadow-md"><h3 className="text-lg font-semibold text-gray-800 mb-4">P√≥dio da Prospec√ß√£o</h3><div className="flex items-end justify-center gap-4 text-center h-52">{podiumOrder.map(index => { const user = topThree[index]; const style = podiumStyles[index]; if (!user) return null; return (<div key={user.id} className="flex flex-col items-center w-28"><span className="text-4xl mb-2">{user.avatar}</span><p className="font-bold text-gray-700 truncate w-full">{user.name}</p><div className={`flex items-center justify-center rounded-t-lg w-full ${style.bgColor} ${style.height}`}><div className="text-white font-black text-4xl" style={{ textShadow: '2px 2px 4px rgba(0,0,0,0.2)' }}>{style.rank}</div></div><div className="bg-slate-700 w-full p-2 rounded-b-lg text-white font-semibold text-sm">{user.score} pts</div></div>);})}</div></div>);};
            const closedWonValue = useMemo(() => prospects.filter(p => p.status === 'Venda').reduce((sum, p) => sum + p.value, 0), [prospects]);
            const activityKpiData = useMemo(() => { const cadenceTasks = tasks.filter(t => t.type === 'Cad√™ncia'); let ligacoes = 0, conexoes = 0, contatoDecisor = 0, reunioes = 0, reunioesRealizadas = 0, vendas = 0; cadenceTasks.forEach(task => { if (task.description.includes('Liga√ß√£o')) ligacoes++; if (task.description.includes('Conex√£o')) conexoes++; if (task.description.includes('Decisor')) contatoDecisor++; if (task.description.includes('Reuni√£o Marcada')) reunioes++; if (task.description.includes('Reuni√£o Realizada')) reunioesRealizadas++; if (task.description.includes('Venda')) vendas++;}); return { ligacoes, conexoes, contatoDecisor, reunioes, reunioesRealizadas, vendas: prospects.filter(p => p.status === 'Venda').length } }, [tasks, prospects]);
            const funnelData = useMemo(() => { const d = {}; KANBAN_STAGES.forEach(s => d[s] = prospects.filter(p => p.status === s).length); return d; }, [prospects]);
            const activitiesPerUser = useMemo(() => { const d = {}; users.forEach(u => d[u.name] = 0); tasks.filter(t => t.completed).forEach(t => { const u = users.find(user => user.id === t.userId); if (u) d[u.name]++; }); return Object.entries(d).sort(([,a],[,b]) => b-a); }, [tasks, users]);
            const leaderboardData = useMemo(() => users.map(user => { const valueSold = prospects.filter(p => p.userId === user.id && p.status === 'Venda').reduce((s, p) => s + p.value, 0); const salesCount = prospects.filter(p => p.userId === user.id && p.status === 'Venda').length; const tasksCompleted = tasks.filter(t => t.userId === user.id && t.completed).length; const score = Math.floor(valueSold / 1000) + (salesCount * 10) + tasksCompleted; return { ...user, score }; }).sort((a, b) => b.score - a.score), [prospects, tasks, users]);
            return (<div className="flex-1 p-4 sm:p-6 lg:p-8 space-y-8 custom-scrollbar overflow-y-auto"><div className="flex justify-between items-center"><div><h1 className="text-2xl font-bold text-gray-800">Dashboard</h1><p className="text-gray-500">Vis√£o geral das suas m√©tricas de prospec√ß√£o</p></div><div className="flex items-center space-x-4"><select className="p-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option>Todos os per√≠odos</option></select><select className="p-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option>Todos os usu√°rios</option>{users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}</select></div></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><ActivityKpiCard title="Liga√ß√µes" value={activityKpiData.ligacoes} iconBgColor="bg-blue-100" icon={Icons.phone} /><ActivityKpiCard title="Conex√µes" value={activityKpiData.conexoes} iconBgColor="bg-green-100" icon={Icons.contact} /><ActivityKpiCard title="Contato Decisor" value={activityKpiData.contatoDecisor} iconBgColor="bg-purple-100" icon={Icons.contact} /><ActivityKpiCard title="Reuni√µes" value={activityKpiData.reunioes} iconBgColor="bg-orange-100" icon={Icons.tasks} /></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><ActivityKpiCard title="Reuni√µes Realizadas" value={activityKpiData.reunioesRealizadas} iconBgColor="bg-teal-100" icon={Icons.check} /><ActivityKpiCard title="Vendas" value={activityKpiData.vendas} iconBgColor="bg-lime-100" icon={Icons.money} /><ActivityKpiCard title="Valor Vendido" value={closedWonValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} iconBgColor="bg-emerald-100" icon={Icons.money} /></div><div className="grid grid-cols-1 lg:grid-cols-2 gap-8"><div className="bg-white p-6 rounded-lg shadow-md"><h3 className="text-lg font-semibold text-gray-800 mb-4">Funil de Vendas</h3><div className="space-y-3">{Object.entries(funnelData).map(([stage, count]) => (<div key={stage}><div className="flex justify-between text-sm mb-1"><span className="font-medium text-gray-600">{stage}</span><span className="font-bold text-gray-800">{count}</span></div><div className="w-full bg-gray-200 rounded-full h-2.5"><div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${prospects.length > 0 ? (count / prospects.length) * 100 : 0}%` }}></div></div></div>))}</div></div><div className="bg-white p-6 rounded-lg shadow-md"><h3 className="text-lg font-semibold text-gray-800 mb-4">Ranking de Atividades</h3><div className="space-y-4">{activitiesPerUser.map(([name, count]) => (<div key={name}><div className="flex justify-between text-sm mb-1"><span className="font-medium text-gray-600">{name}</span><span className="font-bold text-gray-800">{count} tarefas</span></div><div className="w-full bg-gray-200 rounded-full h-4"><div className="bg-green-500 h-4 rounded-full text-center text-white text-xs" style={{ width: `${(count / Math.max(activitiesPerUser[0]?.[1] || 1, 1)) * 100}%` }}></div></div></div>))}</div></div></div><RankingPodium leaderboard={leaderboardData} /></div>);
        }
        
        function App() {
            const [view, setView] = useState('kanban');
            const [prospects, setProspects] = useState(initialProspects);
            const [tasks, setTasks] = useState(initialTasks);
            const [users] = useState(initialUsers);
            const [showConfetti, setShowConfetti] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [selectedProspect, setSelectedProspect] = useState(null);
            const [selectedIds, setSelectedIds] = useState([]);

            const handleCardClick = (prospect) => { setSelectedProspect(prospect); setIsModalOpen(true); };
            const handleCloseModal = () => { setIsModalOpen(false); setSelectedProspect(null); };
            const triggerCelebration = () => { setShowConfetti(true); setTimeout(() => setShowConfetti(false), 4000); };
            const handleStatusChange = (prospectId, newStatus) => { const p = prospects.find(p => p.id === prospectId); if (p && p.status !== 'Venda' && newStatus === 'Venda') triggerCelebration(); setProspects(prev => prev.map(p => p.id === prospectId ? { ...p, status: newStatus } : p)); };
            const handleUpdateProspect = (updatedProspect, changeLog) => { setProspects(prev => prev.map(p => p.id === updatedProspect.id ? { ...updatedProspect, editHistory: [...(p.editHistory || []), ...changeLog] } : p)); };
            const handleRegisterCadence = (prospect, actions) => { const newTask = { id: Date.now(), prospectId: prospect.id, userId: prospect.userId, description: `Cad√™ncia: ${actions.join(', ')}`, dueDate: new Date().toISOString().split('T')[0], completed: true, type: 'Cad√™ncia' }; setTasks(prev => [...prev, newTask]); alert(`${actions.length} a√ß√µes registadas como 1 cad√™ncia para ${prospect.name}!`); };
            const handleTaskToggle = (taskId) => { setTasks(prev => prev.map(t => t.id === taskId ? { ...t, completed: !t.completed } : t)); };
            const handleSelectProspect = (id) => { setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]); };
            const handleAddTask = (prospect, description, dueDate) => { const newTask = { id: Date.now(), prospectId: prospect.id, userId: prospect.userId, description, dueDate, completed: false, type: 'Follow-up' }; setTasks(prev => [...prev, newTask]); alert(`Tarefa '${description}' agendada para ${prospect.name}.`); };
            const handleImportSuccess = (data, mapping) => {
                const existingEmails = prospects.map(p => p.email);
                const newProspects = data.map(record => { let newProspect = { id: Date.now() + Math.random(), userId: 1, editHistory: [] }; for (const header in mapping) { const crmField = mapping[header]; if (crmField) { newProspect[crmField] = record[header]; } } return newProspect; }).filter(p => p.email && !existingEmails.includes(p.email));
                setProspects(prev => [...prev, ...newProspects]);
            };
            const handleExport = (type) => { let dataToExport; switch(type) { case 'selected': dataToExport = prospects.filter(p => selectedIds.includes(p.id)); break; case 'filtered': dataToExport = prospects; break;  case 'all': default: dataToExport = prospects; break; } if(dataToExport.length === 0) { alert("Nenhum contato para exportar."); return; } const headers = Object.keys(CRM_FIELD_LABELS).map(key => CRM_FIELD_LABELS[key]); const csvRows = [headers.join(',')]; dataToExport.forEach(row => { const values = CRM_FIELDS.map(field => { const val = row[field] || ''; const escaped = (''+val).replace(/"/g, '""'); return `"${escaped}"`; }); csvRows.push(values.join(',')); }); downloadCsv(csvRows.join('\n')); setSelectedIds([]); };
            const downloadCsv = (csvContent) => { const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", `export_contatos_${new Date().toISOString().split('T')[0]}.csv`); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); };

            const renderView = () => {
                switch (view) {
                    case 'kanban': return <KanbanView prospects={prospects} users={users} tasks={tasks} onStatusChange={handleStatusChange} onCardClick={handleCardClick} />;
                    case 'list': return <ListView prospects={prospects} users={users} tasks={tasks} onCardClick={handleCardClick} onSelect={handleSelectProspect} selectedIds={selectedIds} />;
                    case 'tasks': return <TasksView tasks={tasks} prospects={prospects} users={users} onTaskToggle={handleTaskToggle} onCardClick={handleCardClick} />;
                    case 'dashboard': default: return <DashboardView prospects={prospects} users={users} tasks={tasks} />;
                }
            };
            
            const NavButton = ({ viewName, icon, children }) => ( <button onClick={() => setView(viewName)} className={`flex items-center space-x-3 px-4 py-2 rounded-lg transition-colors duration-200 ${view === viewName ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-slate-200'}`}>{icon}<span className="font-semibold">{children}</span></button> );

            return (
                <Fragment>
                    {showConfetti && <Confetti />}
                    <ProspectModal isOpen={isModalOpen} onClose={handleCloseModal} prospect={selectedProspect} users={users} tasks={tasks} onSave={handleUpdateProspect} onRegisterCadence={handleRegisterCadence} onAddTask={handleAddTask}/>
                    <ImportModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onImportSuccess={handleImportSuccess} />
                    <div className="h-screen w-screen flex flex-col bg-slate-50">
                        <header className="bg-white shadow-sm p-4 flex justify-between items-center border-b border-gray-200 flex-shrink-0">
                            <div className="flex items-center"><svg className="h-8 w-8 text-blue-600" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg><h1 className="text-xl font-bold text-gray-800 ml-2">ConnectSphere Prospect</h1></div>
                            <nav className="flex items-center space-x-2"><NavButton viewName="dashboard" icon={Icons.dashboard}>Dashboard</NavButton><NavButton viewName="kanban" icon={Icons.kanban}>Kanban</NavButton><NavButton viewName="list" icon={Icons.list}>Lista</NavButton><NavButton viewName="tasks" icon={Icons.tasks}>Tarefas</NavButton></nav>
                            <div className="flex items-center space-x-4">
                                <div className="relative group"><button className="px-4 py-2 bg-white border border-gray-300 rounded-md font-semibold text-gray-700 hover:bg-gray-50">Exportar</button><div className="absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10"><div className="py-1"><a href="#" onClick={(e) => { e.preventDefault(); handleExport('selected')}} className={`block px-4 py-2 text-sm ${selectedIds.length > 0 ? 'text-gray-700 hover:bg-gray-100' : 'text-gray-400 cursor-not-allowed'}`}>Exportar {selectedIds.length} selecionados</a><a href="#" onClick={(e) => { e.preventDefault(); handleExport('filtered')}} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Exportar esta vista</a><a href="#" onClick={(e) => { e.preventDefault(); handleExport('all')}} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Exportar todos</a></div></div></div>
                                <button onClick={() => setIsImportModalOpen(true)} className="px-4 py-2 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700">Importar Contatos</button>
                                <span className="mr-3 font-semibold text-gray-700">Ol√°, {users[1].name}</span><span className="text-3xl">{users[1].avatar}</span>
                            </div>
                        </header>
                        <main className="flex-1 overflow-y-auto">{renderView()}</main>
                    </div>
                </Fragment>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
